<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Instagram Feed Preview</title>
  <link rel="stylesheet" href="https://widget.artyzan-agency.com/static/style.css">
</head>
<body>
    <div class="widget-container">
        <!-- Titre du widget -->
        <h2 class="widget-title">Aperçu du feed Instagram</h2>

        <!-- Ligne avec les trois boutons -->
        <div class="button-container">
          <button id="prev-btn" class="action-btn">Précédent</button>
          <button id="refresh-btn" class="action-btn">Rafraîchir</button>
          <button id="next-btn" class="action-btn">Suivant</button>
        </div>

        <!-- Conteneur de la grille -->
        <div id="grid" class="grid-container">
          <!-- Les images seront insérées dynamiquement ici -->
        </div>

        <div class="config-container">
          <h3 class="config-title">Configuration Notion</h3>
          <form id="config-form">
            <div>
              <label for="api-key-input" class="config-label">Clé API Notion :</label>
              <input type="text" id="api-key-input" class="config-input" placeholder="API">
            </div>
            <div>
              <label for="database-id-input" class="config-label">ID de la base de données :</label>
              <input type="text" id="database-id-input" class="config-input" placeholder="ID">
            </div>
            <button id="save-config-btn" class="action-btn">Enregistrer</button>
          </form>
        </div>

          <!-- Zone masquée après enregistrement -->
          <div id="config-summary" style="display: none;">
            <h3 class="config-title">Résumé de la configuration</h3>
            <p>Clé API Notion : <span id="masked-api-key">********</span></p>
            <p>ID de la base de données : <span id="masked-database-id">********</span></p>
            <button id="edit-config-btn" class="action-btn">Modifier</button>
          </div>
        </div>
      

        <script>
          let currentPage = 1; // Page actuelle
          const limit = 12; // Nombre d'images par page

          // Fonction pour afficher la configuration
          function showConfig() {
            resetGrid(); // Réinitialise la grille
            console.log("showConfig appelée");

            const configContainer = document.querySelector(".config-container");
            const configSummary = document.getElementById("config-summary");

            if (configContainer) {
              configContainer.style.display = "block"; // Affiche le formulaire
              console.log("Configuration visible.");
            } else {
              console.error("config-container introuvable.");
            }
            
            if (configSummary) {
              configSummary.style.display = "none"; // Masque le résumé
              console.log("Résumé masqué.");
            } else {
              console.error("config-summary introuvable.");
            }
          }

          // Fonction pour masquer la configuration après sauvegarde
          function hideConfig() {
            console.log("hideConfig appelée");

            const configContainer = document.querySelector(".config-container");
            const configSummary = document.getElementById("config-summary");

            if (configContainer) {
              configContainer.style.display = "none"; // Cache le formulaire
              console.log("Config-container masquée.");
            } else {
              console.error("Erreur : .config-container introuvable.");
            }

            if (configSummary) {
              configSummary.style.display = "block"; // Affiche le résumé
              console.log("Résumé de configuration affiché.");

              const maskedApiKey = document.getElementById("masked-api-key");
              const maskedDatabaseId = document.getElementById("masked-database-id");

              if (maskedApiKey && maskedDatabaseId) {
                maskedApiKey.textContent = "************"; // Placeholder pour la clé API
                maskedDatabaseId.textContent = "************"; // Placeholder pour l'ID
                console.log("Données masquées mises à jour.");
              } else {
                console.error("Impossible de trouver les éléments pour afficher les données masquées.");
              }
            } else {
              console.error("Erreur : config-summary introuvable.");
            }
          }

          // Fonction pour sauvegarder la configuration
          function saveConfig(apiKey, databaseId) {
            console.log("saveConfig appelée avec API et Database ID :", apiKey, databaseId);

            const grid = document.getElementById("grid");
            const editConfigBtn = document.getElementById("edit-config-btn");

            if (grid) {
              grid.innerHTML = "<p>Chargement en cours...</p>";
              console.log("Grille en cours de chargement...");
            } else {
              console.error("Grille introuvable dans le DOM.");
            }

            return fetch("/config", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                api_key: apiKey.trim(),
                database_id: databaseId.trim(),
              }),
            })
              .then((response) => {
                console.log("Réponse brute API /config :", response);
                if (!response.ok) {
                  throw new Error(`Erreur API /config : ${response.status} ${response.statusText}`);
                }
                return response.json();
              })
              .then((data) => {
                console.log("Configuration sauvegardée avec succès :", data);
                return loadPage(1); // Charge la première page
              })
              .then(() => {
                console.log("Chargement de la première page réussi.");
                alert("Configuration sauvegardée !");
                hideConfig(); // Cache le formulaire
                if (editConfigBtn) editConfigBtn.style.display = "inline-block"; // Affiche le bouton Modifier
              })
              .catch((error) => {
                console.error("Erreur lors de la sauvegarde de la configuration :", error);
                resetGrid(); // Réinitialise la grille
                if (grid) {
                  grid.innerHTML = "<p>Impossible de charger le feed. Vérifiez la configuration.</p>";
                }
              });
          }

          // Fonction pour charger une page spécifique
          function loadPage(page) {
            const apiKey = localStorage.getItem("api_key"); // Récupère la clé API (ou autre méthode de stockage)
            const databaseId = localStorage.getItem("database_id");
            const grid = document.getElementById("grid");

            if (!apiKey || !databaseId) {
              console.warn("Configuration manquante. Impossible de charger la page.");
              if (grid) grid.innerHTML = "<p>Aucune configuration disponible.</p>";
              return; // Stoppe l'exécution si pas de configuration
            }

            console.log("Chargement du feed pour la page :", page);
            grid.innerHTML = "<p>Chargement du feed...</p>";


            // Reste de la fonction pour récupérer les images
            fetch(`/images?page=${page}&limit=${limit}`)
              .then((response) => {
                console.log("Réponse brute API /images :", response);
                if (!response.ok) {
                  throw new Error(`Erreur API /images : ${response.status} ${response.statusText}`);
                }
                return response.json();
              })
              .then((data) => {
                console.log("Données reçues de l'API /images :", data);

                grid.innerHTML = ""; // Réinitialiser le contenu

                data.images.forEach((url) => {
                  const div = document.createElement("div");
                  div.className = "grid-item";
                  div.style.backgroundImage = `url(${url})`;
                  grid.appendChild(div);
                });

                // Compléter avec des cases vides si nécessaire
                for (let i = data.images.length; i < limit; i++) {
                  const emptyDiv = document.createElement("div");
                  emptyDiv.className = "grid-item empty";
                  grid.appendChild(emptyDiv);
                }

                // Mise à jour des boutons de navigation
                if (prevBtn) prevBtn.style.display = data.page > 1 ? "inline-block" : "none";
                if (nextBtn) nextBtn.style.display = data.page < data.pages ? "inline-block" : "none";

                // Affiche le bouton Modifier
                if (editConfigBtn) editConfigBtn.style.display = "inline-block";
              })
              .catch((error) => {
                console.error("Erreur lors de la récupération des données :", error);
                resetGrid(); // Réinitialise la grille en cas d'échec
                grid.innerHTML = "<p>Erreur lors du chargement du feed. Veuillez vérifier la clé API et/ou l'ID.</p>";

                // Masque les boutons de navigation
                if (prevBtn) prevBtn.style.display = "none";
                if (nextBtn) nextBtn.style.display = "none";

                // Masque le bouton Modifier
                if (editConfigBtn) editConfigBtn.style.display = "none";
              });
          }

          // Fonction pour vider la grille
          function resetGrid() {
            console.log("resetGrid appelée.");
            const grid = document.getElementById("grid");
            if (grid) {
              grid.innerHTML = ""; // Vide la grille
              console.log("Grille vidée.");
            } else {
              console.error("Grille introuvable pour resetGrid.");
            }
          }

          // Initialisation des événements
          document.addEventListener("DOMContentLoaded", () => {
            console.log("DOMContentLoaded appelée.");

            const saveConfigBtn = document.getElementById("save-config-btn");
            const prevBtn = document.getElementById("prev-btn");
            const nextBtn = document.getElementById("next-btn");
            const refreshBtn = document.getElementById("refresh-btn");
            const editConfigBtn = document.getElementById("edit-config-btn");

            // Masquage initial des boutons
            if (prevBtn) prevBtn.style.display = "none";
            if (nextBtn) nextBtn.style.display = "none";
            if (editConfigBtn) editConfigBtn.style.display = "none";

            // Gestion du bouton "Enregistrer"
            if (saveConfigBtn) {
              saveConfigBtn.addEventListener("click", () => {
                console.log("Bouton 'Enregistrer' cliqué.");
                const apiKey = document.getElementById("api-key-input")?.value;
                const databaseId = document.getElementById("database-id-input")?.value;

                if (apiKey && databaseId) {
                // Sauvegarde de la configuration et chargement automatique de la grille
                saveConfig(apiKey, databaseId).then(() => {
                  console.log("Configuration enregistrée et chargement automatique.");
                  loadPage(currentPage); // Charge la page automatiquement après la sauvegarde
                });
              } else {
                alert("Veuillez remplir les deux champs avant d'enregistrer.");
              }
            });
          }

            // Vérifie le bouton Rafraîchir
            if (refreshBtn) {
            refreshBtn.addEventListener("click", () => {
              console.log("Bouton 'Rafraîchir' cliqué.");
              const apiKey = document.getElementById("api-key-input")?.value;
              const databaseId = document.getElementById("database-id-input")?.value;

              // Vérifie si les clés API et Database ID sont configurées
              if (apiKey && databaseId) {
                loadPage(currentPage); // Charge la page seulement si la configuration est valide
              } else {
                console.warn("Configuration manquante. Impossible de rafraîchir le widget.");
                alert("Configuration manquante. Veuillez configurer avant de rafraîchir.");
              }
            });
          }
            // Gestion du bouton Modifier
  if (editConfigBtn) {
    editConfigBtn.addEventListener("click", () => {
      console.log("Bouton 'Modifier' cliqué.");
      resetGrid(); // Réinitialise la grille
      showConfig(); // Affiche le formulaire de configuration
    });
  }
}); // Fermeture correcte du DOMContentLoaded
</script>