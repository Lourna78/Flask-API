<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Instagram Feed Preview</title>
  <link rel="stylesheet" href="https://widget.artyzan-agency.com/static/style.css">
  <script>
/* -------------------------
   1. Variables globales
------------------------- */
const API_ENDPOINT = "/config"; // Endpoint pour sauvegarder la configuration
let currentPage = 1; // Page actuelle
const limit = 12; // Nombre d'images par page

/* -------------------------
   2. Fonctions utilitaires
------------------------- */

/**
 * Affiche un message d'erreur dans la console.
 * @param {string} message - Le message d'erreur.
 */
function logError(message) {
  console.error(`[Erreur] ${message}`);
}

/**
 * Montre ou cache un élément HTML en fonction de son ID.
 * @param {string} id - L'ID de l'élément HTML.
 * @param {boolean} show - `true` pour afficher, `false` pour cacher.
 */
function toggleVisibility(id, show) {
  const element = document.getElementById(id);
  if (element) {
    element.style.display = show ? "block" : "none";
  } else {
    logError(`L'élément avec l'ID '${id}' est introuvable.`);
  }
}

/* -------------------------
   3. Gestion de l'API et des données
------------------------- */

/**
 * Sauvegarde la configuration utilisateur via l'API.
 * @param {string} apiKey - Clé API de l'utilisateur.
 * @param {string} databaseId - ID de la base de données.
 */
function saveConfig(apiKey, databaseId) {
  return fetch(API_ENDPOINT, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({ api_key: apiKey.trim(), database_id: databaseId.trim() }),
  })
    .then((response) => {
      if (!response.ok) throw new Error("Erreur lors de la sauvegarde de la configuration.");
      return response.json();
    })
    .then((data) => {
      console.log("Configuration sauvegardée :", data);

      // Cache le panneau de configuration et affiche la grille
      toggleVisibility("config-container", false); // Cache la configuration
      toggleVisibility("grid", true); // Affiche la grille
      loadPage(1); // Charge la première page du widget
    })
    .catch((error) => logError(`Erreur lors de la sauvegarde : ${error.message}`));
}

/**
 * Charge une page spécifique du widget.
 * @param {number} page - Numéro de la page.
 */
function loadPage(page) {
  const grid = document.getElementById("grid");

  if (!grid) {
    logError("L'élément 'grid' n'existe pas dans le DOM.");
    return;
  }

  // Affiche un message de chargement
  grid.innerHTML = "<p>Chargement du feed...</p>";

  fetch(`/images?page=${page}&limit=${limit}`)
    .then((response) => response.json())
    .then((data) => {
      grid.innerHTML = ""; // Vide la grille

      // Ajoute les images dans la grille
      data.images.forEach((url) => {
        const div = document.createElement("div");
        div.className = "grid-item";
        div.style.backgroundImage = `url(${url})`;
        grid.appendChild(div);
      });

      // Complète avec des cases vides si nécessaire
      for (let i = data.images.length; i < limit; i++) {
        const emptyDiv = document.createElement("div");
        emptyDiv.className = "grid-item empty";
        grid.appendChild(emptyDiv);
      }
    })
    .catch((error) => {
      logError(`Erreur lors du chargement de la page : ${error.message}`);
      grid.innerHTML = "<p>Erreur lors du chargement du feed.</p>";
    });
}

/* -------------------------
   4. Gestion du DOM
------------------------- */

/**
 * Affiche le panneau de configuration initial.
 */
function showConfig() {
  const configContainer = document.getElementById("config-container");
  const grid = document.getElementById("grid");

  if (!configContainer) {
    logError("Le conteneur de configuration n'existe pas.");
    return;
  }

  // Réinitialise le contenu du panneau de configuration
  configContainer.innerHTML = `
    <h3>Configuration Notion</h3>
    <label for="api-key-input">Clé API Notion :</label>
    <input type="text" id="api-key-input" placeholder="Entrez votre clé API">
    <label for="database-id-input">ID de la base de données :</label>
    <input type="text" id="database-id-input" placeholder="Entrez l'ID de la base">
    <button id="save-config-btn">Enregistrer</button>
  `;

  // Ajoute un événement au bouton "Enregistrer"
  const saveConfigBtn = document.getElementById("save-config-btn");
  if (saveConfigBtn) {
    saveConfigBtn.addEventListener("click", () => {
      const apiKey = document.getElementById("api-key-input")?.value;
      const databaseId = document.getElementById("database-id-input")?.value;

      if (apiKey && databaseId) {
        saveConfig(apiKey, databaseId);
      } else {
        alert("Veuillez remplir tous les champs !");
      }
    });
  }

  // Cache la grille et affiche le panneau de configuration
  if (grid) {
    grid.innerHTML = "<p>Configurez votre widget.</p>";
    toggleVisibility("grid", false);
  }
  toggleVisibility("config-container", true);
}

/**
 * Cache le panneau de configuration et affiche le bouton "Modifier".
 */
function hideConfig() {
  const configContainer = document.getElementById("config-container");

  if (!configContainer) {
    logError("Le conteneur de configuration n'existe pas.");
    return;
  }

  configContainer.innerHTML = `
    <h3>Configuration Notion</h3>
    <p>Clé API Notion : ************</p>
    <p>ID de la base de données : ************</p>
    <button id="modify-config-btn">Modifier</button>
  `;

  // Ajoute un événement au bouton "Modifier"
  const modifyConfigBtn = document.getElementById("modify-config-btn");
  if (modifyConfigBtn) {
    modifyConfigBtn.addEventListener("click", () => {
      showConfig(); // Retourne au panneau de configuration initial
    });
  }
}

/* -------------------------
   5. Gestionnaires d'événements
------------------------- */

document.addEventListener("DOMContentLoaded", () => {
  const grid = document.getElementById("grid");
  const configContainer = document.getElementById("config-container");

  // Cache la grille au démarrage
  if (grid) {
    grid.style.display = "none";
  }

  // Affiche la configuration au démarrage
  if (configContainer) {
    showConfig();
  }

  // Ajoute les événements pour les boutons de navigation
  document.getElementById("prev-btn")?.addEventListener("click", () => {
    if (currentPage > 1) {
      currentPage--;
      loadPage(currentPage);
    }
  });

  document.getElementById("next-btn")?.addEventListener("click", () => {
    currentPage++;
    loadPage(currentPage);
  });

  document.getElementById("refresh-btn")?.addEventListener("click", () => {
    loadPage(currentPage);
  });
});
    </script>
</head>
<body>
    <div class="widget-container">
        <!-- Titre du widget -->
        <h2 class="widget-title">Aperçu du feed Instagram</h2>

        <!-- Ligne avec les trois boutons -->
        <div class="button-container">
          <button id="prev-btn" class="action-btn">Précédent</button>
          <button id="refresh-btn" class="action-btn">Rafraîchir</button>
          <button id="next-btn" class="action-btn">Suivant</button>
        </div>

        <!-- Conteneur de la grille -->
        <div id="grid" class="grid-container">
          <!-- Les images seront insérées dynamiquement ici -->
        </div>

        <div class="config-container">
          <h3>Configuration Notion</h3>
          <form id="config-form"></form>
          <!-- Zone de configuration -->
          <div id="config-form">
            <label for="api-key-input">Clé API Notion :</label>
            <input type="text" id="api-key-input" placeholder="Entrez votre clé API">
            <label for="database-id-input">ID de la base de données :</label>
            <input type="text" id="database-id-input" placeholder="Entrez l'ID de la base">
            <button id="save-config-btn">Enregistrer</button>
          </div>
          <!-- Zone masquée après enregistrement -->
          <div id="config-summary" style="display: none;">
            <p>Clé API Notion : <span id="masked-api-key">********</span></p>
            <p>ID de la base de données : <span id="masked-database-id">********</span></p>
            <button id="edit-config-btn">Modifier</button>
          </form>
          </div>
        </script>
</body>
</html>