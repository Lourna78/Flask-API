<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Instagram Feed Widget</title>
  <link rel="stylesheet" href="https://widget.artyzan-agency.com/static/style.css">
</head>
<body>
  <div class="widget-container">
    <h2 class="widget-title">Aperçu du feed Instagram</h2>

    <!-- Navigation -->
    <div class="button-container">
      <button id="prev-btn" class="action-btn">Précédent</button>
      <button id="refresh-btn" class="action-btn">Rafraîchir</button>
      <button id="next-btn" class="action-btn">Suivant</button>
    </div>

    <!-- Grille des images -->
    <div id="grid" class="grid-container"></div>

    <!-- Formulaire de configuration -->
    <div class="config-container">
      <h3 class="config-title">Configuration</h3>
      <form id="config-form">
        <label>Clé API :</label>
        <input type="text" id="api-key-input" placeholder="Votre clé API">
        <label>ID de la base :</label>
        <input type="text" id="database-id-input" placeholder="Votre ID de base">
        <button type="button" id="save-config-btn" class="action-btn">Enregistrer</button>
      </form>
    </div>

    <!-- Résumé de la configuration -->
    <div id="config-summary" style="display: none;">
      <h3>Résumé</h3>
      <p>Clé API : <span id="masked-api-key">********</span></p>
      <p>ID de la base : <span id="masked-database-id">********</span></p>
      <button id="edit-config-btn" class="action-btn">Modifier</button>
    </div>
  </div>

  <script>
    // Variables globales
    let currentPage = 1;
    const limit = 12; // Nombre d'images par page

    // Réinitialise la grille
    function resetGrid() {
      const grid = document.getElementById("grid");
      if (grid) grid.innerHTML = ""; // Vide la grille
    }

    // Affiche la configuration
    function showConfig() {
      document.querySelector(".config-container").style.display = "block";
      document.getElementById("config-summary").style.display = "none";
      resetGrid(); // Vide la grille
    }

    // Masque la configuration après sauvegarde
    function hideConfig() {
      document.querySelector(".config-container").style.display = "none";
      document.getElementById("config-summary").style.display = "block";
    }

    // Sauvegarde la configuration et charge le feed
    function saveConfig(apiKey, databaseId) {
      console.log("Configuration sauvegardée :", { apiKey, databaseId });

      // Stockage local pour conserver les infos
      localStorage.setItem("api_key", apiKey);
      localStorage.setItem("database_id", databaseId);

      // Affiche le résumé et charge automatiquement le feed
      document.getElementById("masked-api-key").textContent = "********";
      document.getElementById("masked-database-id").textContent = "********";
      hideConfig();
      loadPage(currentPage);
    }

    // Charge une page spécifique
    function loadPage(page) {
      const apiKey = localStorage.getItem("api_key");
      const databaseId = localStorage.getItem("database_id");
      const grid = document.getElementById("grid");

      if (!apiKey || !databaseId) {
        console.warn("Configuration manquante !");
        resetGrid();
        return;
      }

      grid.innerHTML = "<p>Chargement...</p>";

      fetch(`/images?page=${page}&limit=${limit}`, {
        headers: { "Authorization": `Bearer ${apiKey}` },
      })
        .then(response => {
          if (!response.ok) throw new Error("Erreur API");
          return response.json();
        })
        .then(data => {
          resetGrid(); // Réinitialise la grille
          data.images.forEach(url => {
            const div = document.createElement("div");
            div.className = "grid-item";
            div.style.backgroundImage = `url(${url})`;
            grid.appendChild(div);
          });
        })
        .catch(error => {
          console.error("Erreur lors du chargement des images :", error);
          grid.innerHTML = "<p>Erreur lors du chargement du feed.</p>";
        });
    }

    // Initialisation des événements
    document.addEventListener("DOMContentLoaded", () => {
      console.log("Initialisation du widget.");

      const saveConfigBtn = document.getElementById("save-config-btn");
      const refreshBtn = document.getElementById("refresh-btn");
      const prevBtn = document.getElementById("prev-btn");
      const nextBtn = document.getElementById("next-btn");
      const editConfigBtn = document.getElementById("edit-config-btn");

      // Gestion des boutons
      if (saveConfigBtn) {
        saveConfigBtn.addEventListener("click", () => {
          const apiKey = document.getElementById("api-key-input").value;
          const databaseId = document.getElementById("database-id-input").value;
          if (apiKey && databaseId) saveConfig(apiKey, databaseId);
          else alert("Veuillez remplir les champs requis.");
        });
      }

      if (refreshBtn) {
        refreshBtn.addEventListener("click", () => {
          loadPage(currentPage);
        });
      }

      if (prevBtn) {
        prevBtn.addEventListener("click", () => {
          if (currentPage > 1) {
            currentPage--;
            loadPage(currentPage);
          }
        });
      }

      if (nextBtn) {
        nextBtn.addEventListener("click", () => {
          currentPage++;
          loadPage(currentPage);
        });
      }

      if (editConfigBtn) {
        editConfigBtn.addEventListener("click", showConfig);
      }

      // Au chargement, vérifie la configuration et affiche la grille vide
      resetGrid();
    });
  </script>
</body>
</html>
